// Arquivo: backend/src/server.js

const express = require('express');
const cors = require('cors');
const session = require('express-session');
const cookieParser = require('cookie-parser');
const passport = require('./config/passport');
require('dotenv').config();

// --- 1. IMPORTAR TODAS AS NOSSAS ROTAS ---
const authRoutes = require('./routes/authRoutes');
const googleAuthRoutes = require('./routes/googleAuthRoutes'); // Rotas Google OAuth
const dominiosRoutes = require('./routes/dominiosRoutes'); // Rotas de gerenciamento de dom√≠nios
const bookRoutes = require('./routes/bookRoutes');
const authorRoutes = require('./routes/authorRoutes');
const categoryRoutes = require('./routes/categoryRoutes');
const reservationRoutes = require('./routes/reservationRoutes');
const loanRoutes = require('./routes/loanRoutes');
const relatorioRoutes = require('./routes/relatorioRoutes'); // Rota de Relat√≥rios
const userRoutes = require('./routes/userRoutes');       // <-- A LINHA QUE FALTAVA
const dashboardRoutes = require('./routes/dashboardRoutes'); // 1. IMPORTE AQUI
const perfilRoutes = require('./routes/perfilRoutes'); // 1. IMPORTE AQUI
const conquistasRoutes = require('./routes/conquistasRoutes'); // 1. IMPORTE AQUI
const financeiroRoutes = require('./routes/financeiroRoutes'); // 1. IMPORTE AQUI
const pedidoRoutes = require('./routes/pedidoRoutes');
const publicRoutes = require('./routes/publicRoutes'); // Rotas p√∫blicas (sem autentica√ß√£o)
const avaliacoesRoutes = require('./routes/avaliacoesRoutes'); // Sistema de avalia√ß√µes de livros

// Rotas de sess√£o e logs
const sessionRoutes = require('./routes/sessionRoutes'); // Heartbeat e logout
const accessLogsRoutes = require('./routes/accessLogsRoutes'); // Logs de acesso
const diagnosticoRoutes = require('./routes/diagnosticoRoutes'); // Diagn√≥stico

const app = express();

// Configura√ß√£o de CORS - Permitir m√∫ltiplas origens
const allowedOrigins = [
  'http://localhost:3000',
  'http://localhost:3001',
  'http://192.168.0.109:3000',
  'http://192.168.0.110:3000',
  process.env.FRONTEND_URL
].filter(Boolean);

app.use(cors({
  origin: function (origin, callback) {
    // Permitir requisi√ß√µes sem origin (como mobile apps ou curl)
    if (!origin) return callback(null, true);

    if (allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true);
    } else {
      console.log('Origem bloqueada pelo CORS:', origin);
      callback(null, true); // Permitir todas em desenvolvimento
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

app.use(express.json());
app.use(cookieParser());

// MIDDLEWARE DE LOG - Captura TODAS as requisi√ß√µes
app.use((req, res, next) => {
  console.log(`\n========== NOVA REQUISI√á√ÉO ==========`);
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
  console.log('Authorization Header:', req.headers.authorization ? 'Present' : 'Missing');
  console.log('====================================\n');
  next();
});

// Configura√ß√£o de sess√£o (necess√°ria para o Passport)
app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production', // true em produ√ß√£o (HTTPS)
    httpOnly: true,
    maxAge: 8 * 60 * 60 * 1000 // 8 horas
  }
}));

// Inicializar Passport
app.use(passport.initialize());
app.use(passport.session());

const PORT = process.env.PORT || 3001;

// --- 2. USAR AS ROTAS QUE IMPORTAMOS ---
// IMPORTANTE: Rotas p√∫blicas devem vir ANTES das rotas protegidas
app.use('/api/auth', authRoutes);
app.use('/api/auth', googleAuthRoutes); // Rotas de autentica√ß√£o Google
app.use('/api', bookRoutes); // Livros (tem rotas p√∫blicas)
app.use('/api', authorRoutes);
app.use('/api', categoryRoutes);
app.use('/api', dominiosRoutes); // Rotas de gerenciamento de dom√≠nios (admin)
app.use('/api', reservationRoutes);
app.use('/api', loanRoutes);
app.use('/api', relatorioRoutes);
app.use('/api', userRoutes); // <-- Agora esta linha vai funcionar
app.use('/api', dashboardRoutes); // 2. REGISTRE AQUI
app.use('/api', perfilRoutes); // 2. REGISTRE AQUI
app.use('/api', conquistasRoutes); // 2. REGISTRE AQUI
app.use('/api', financeiroRoutes); // 2. REGISTRE AQUI
app.use('/api', pedidoRoutes);
app.use('/api/public', publicRoutes); // Rotas p√∫blicas (sem autentica√ß√£o necess√°ria)
app.use('/api', avaliacoesRoutes); // Sistema de avalia√ß√µes de livros

// Rotas de sess√£o e logs
app.use('/api/session', sessionRoutes); // Heartbeat e logout
app.use('/api/access-logs', accessLogsRoutes); // Logs de acesso (Admin)
app.use('/api', diagnosticoRoutes); // Diagn√≥stico de token

// Rota principal de teste
app.get('/', (req, res) => {
  res.send('<h1>API do Bibliotech est√° no ar!</h1>');
});

app.listen(PORT, () => {
  console.log(`üöÄ Servidor rodando na porta ${PORT}.`);
});
